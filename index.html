<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>TradeLive — User</title>

  <!-- Chart.js & Socket.IO client -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

  <style>
    :root{--bg:#06121a;--card:#0e1620;--muted:#9aa7b2;--accent:#ff9800;--green:#00d27a;--red:#ff4d4f}
    *{box-sizing:border-box} body{margin:0;background:linear-gradient(180deg,#031018,#071017);font-family:Inter,system-ui;color:#e6eef3}
    .wrap{max-width:1100px;margin:20px auto;padding:16px}
    header{display:flex;justify-content:space-between;align-items:center}
    .logo{display:flex;align-items:center;gap:10px}
    .box{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#ffb86b);display:flex;align-items:center;justify-content:center;font-weight:800;color:#061018}
    .three-dot{cursor:pointer;padding:8px;border-radius:8px}
    .menu{position:absolute;right:18px;top:70px;background:var(--card);padding:12px;border-radius:10px;min-width:320px;box-shadow:0 10px 30px rgba(0,0,0,0.6);display:none}
    .menu.show{display:block}
    .card{background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.6);margin-top:12px}
    .graph{position:relative;height:360px;border-radius:10px;overflow:hidden}
    canvas{width:100%!important;height:320px!important;background:transparent;display:block}
    .floating{position:absolute;right:14px;top:14px;padding:8px 10px;border-radius:10px;background:rgba(2,8,12,0.6);font-weight:700}
    .info-row{display:flex;gap:10px;margin-top:10px;flex-wrap:wrap}
    .pill{background:linear-gradient(180deg,rgba(255,255,255,0.01),rgba(0,0,0,0.03));padding:8px 10px;border-radius:10px;min-width:100px;text-align:center}
    .bet-area{display:flex;gap:10px;margin-top:12px}
    .lane{flex:1;padding:14px;border-radius:10px;text-align:center;user-select:none;border:1px solid rgba(255,255,255,0.03)}
    .lane.up{background:linear-gradient(180deg,rgba(0,210,122,0.04),rgba(0,210,122,0.01))}
    .lane.down{background:linear-gradient(180deg,rgba(255,77,79,0.03),rgba(255,77,79,0.01))}
    .controls{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px}
    input{padding:8px;border-radius:8px;border:none;background:#07121a;color:#e6eef3}
    .btn{background:linear-gradient(180deg,var(--accent),#ffb86b);color:#061018;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
    .ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted)}
    .small{font-size:13px;color:var(--muted)}
    .ledger{margin-top:10px;background:rgba(0,0,0,0.04);padding:10px;border-radius:8px;font-size:13px;color:var(--muted)}
    @media(max-width:900px){ .bet-area{flex-direction:column} .menu{left:8px;right:8px} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo">
        <div class="box">T</div>
        <div>
          <h2 style="margin:0">TradeLive — Real</h2>
          <div class="small">Server-driven rounds • Socket realtime</div>
        </div>
      </div>
      <div style="position:relative">
        <div class="three-dot" id="threeDot">⋮</div>
        <div class="menu" id="menu">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <strong>Wallet & Deposit</strong>
            <small class="small">Hidden</small>
          </div>

          <div style="margin-top:8px">
            <small>Deposit Wallet</small>
            <div id="walletAddress" style="font-weight:700;margin-top:6px">0xYourWalletHereABC123</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn" id="copyBtn">Copy</button>
              <button class="btn ghost" id="changeBtn">Change</button>
            </div>
          </div>

          <div style="margin-top:10px">
            <small>Submit Transaction ID</small>
            <input id="txnInput" placeholder="Txn ID (after sending payment)" />
            <div style="display:flex;gap:8px;margin-top:8px">
              <button class="btn" id="submitTxn">Submit</button>
              <button class="btn ghost" id="clearLocal">Clear</button>
            </div>
            <div class="small" style="margin-top:8px">Status: <span id="depositStatus">—</span></div>
          </div>
        </div>
      </div>
    </header>

    <!-- Top info -->
    <div class="card">
      <div class="graph">
        <canvas id="priceChart"></canvas>
        <div class="floating" id="floatingPrice"><span id="priceArrow">▲</span>&nbsp;<span id="priceValue">$0.000</span></div>

        <div class="info-row">
          <div class="pill">Round: <strong id="roundNum">0</strong></div>
          <div class="pill">Phase: <strong id="phase">—</strong></div>
          <div class="pill">Timer: <strong id="timer">—</strong></div>
          <div class="pill">Players: <strong id="playersCount">1</strong></div>
        </div>

        <div class="bet-area" id="betArea" aria-hidden="false">
          <div class="lane up" id="laneUp">
            <h3>UP</h3><div class="small">Place bets</div><div id="upTotal" style="margin-top:8px;font-weight:700">0</div>
          </div>
          <div class="lane down" id="laneDown">
            <h3>DOWN</h3><div class="small">Place bets</div><div id="downTotal" style="margin-top:8px;font-weight:700">0</div>
          </div>
        </div>

        <div class="controls">
          <input id="betAmount" placeholder="Bet amount" style="width:120px" />
          <button class="btn" id="betUpBtn">Bet UP</button>
          <button class="btn" id="betDownBtn">Bet DOWN</button>
        </div>

        <div class="ledger" id="ledger">
          <div><strong>Your balance:</strong> <span id="balance">1000</span></div>
          <div class="small" style="margin-top:6px">Recent rounds and bets below</div>
          <div id="recent" style="margin-top:8px"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ---------------------
  Configuration
--------------------- */
const API_BASE = ''; // if backend hosted elsewhere set base URL (e.g. 'https://api.example.com')
const SOCKET_PATH = '/socket.io'; // default
const STORAGE_KEY = 'tradelive_price_points_v1';
const BAL_KEY = 'tradelive_balance_v1';

/* ---------------------
  UI refs
--------------------- */
const el = id => document.getElementById(id);
const menu = el('menu'), threeDot = el('threeDot');
const walletEl = el('walletAddress'), copyBtn = el('copyBtn'), changeBtn = el('changeBtn');
const txnInput = el('txnInput'), submitTxn = el('submitTxn'), depositStatus = el('depositStatus'), clearLocal = el('clearLocal');

const roundNumEl = el('roundNum'), phaseEl = el('phase'), timerEl = el('timer'), playersCountEl = el('playersCount');
const upTotalEl = el('upTotal'), downTotalEl = el('downTotal');
const betAmountInput = el('betAmount'), betUpBtn = el('betUpBtn'), betDownBtn = el('betDownBtn');
const recentEl = el('recent'), balanceEl = el('balance');
const priceValue = el('priceValue'), priceArrow = el('priceArrow');

/* ---------------------
  Three-dot menu toggle
--------------------- */
threeDot.addEventListener('click', ()=> menu.classList.toggle('show'));
document.addEventListener('click', (e)=> { if(!threeDot.contains(e.target) && !menu.contains(e.target)) menu.classList.remove('show'); });

/* ---------------------
  Wallet/deposit (UI) - submit txn to backend
--------------------- */
walletEl.innerText = localStorage.getItem('tradelive_wallet') || walletEl.innerText;
balanceEl.innerText = Number(localStorage.getItem(BAL_KEY) || 1000).toFixed(2);

copyBtn.addEventListener('click', async ()=> {
  try { await navigator.clipboard.writeText(walletEl.innerText); alert('Wallet copied'); } catch(e){ alert('Copy failed'); }
});
changeBtn.addEventListener('click', ()=> {
  const v = prompt('Set deposit wallet', walletEl.innerText);
  if(v){ walletEl.innerText = v; localStorage.setItem('tradelive_wallet', v); }
});

submitTxn.addEventListener('click', async ()=> {
  const txn = txnInput.value.trim();
  if(!txn) return alert('Enter transaction id');
  try {
    // send to backend
    const res = await fetch(API_BASE + '/api/deposits', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ wallet: walletEl.innerText, txn })
    });
    if(!res.ok) throw new Error('submit failed');
    const data = await res.json();
    depositStatus.innerText = 'Submitted (pending)';
    txnInput.value = '';
  } catch(err) {
    console.error(err);
    alert('Deposit submit failed');
  }
});
clearLocal.addEventListener('click', ()=> { if(confirm('Clear local deposit?')) { depositStatus.innerText = '—'; } });

/* ---------------------
  Chart (client-side display, server sends live prices)
--------------------- */
const ctx = document.getElementById('priceChart').getContext('2d');
function loadPoints(){ try{ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null;}catch(e){return null;} }
function savePoints(arr){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }catch(e){} }

let points = loadPoints() || (function seed(){
  const start = 100 + Math.random()*6;
  const a=[start];
  for(let i=1;i<40;i++){ const last=a[a.length-1]; const change=(Math.random()-0.4)*1.0; a.push(Math.max(1, +(last+change).toFixed(3))); }
  savePoints(a); return a;
})();

function makeGradient(up=true){
  const g = ctx.createLinearGradient(0,0,0,320);
  if(up){ g.addColorStop(0,'rgba(0,210,122,0.16)'); g.addColorStop(1,'rgba(0,210,122,0.02)'); }
  else { g.addColorStop(0,'rgba(255,77,79,0.12)'); g.addColorStop(1,'rgba(255,77,79,0.02)'); }
  return g;
}

const chart = new Chart(ctx, {
  type:'line',
  data:{ labels: points.map((_,i)=>i), datasets:[{ data:points, borderWidth:2.4, borderColor:'#00d27a', backgroundColor: makeGradient(true), fill:true, tension:0.36, pointRadius:0 }]},
  options:{ animation:{duration:400,easing:'linear'}, plugins:{legend:{display:false},tooltip:{enabled:false}}, scales:{x:{display:false},y:{display:false}}, responsive:true, maintainAspectRatio:false }
});

function updateChartWithPrice(next){
  points.push(next);
  if(points.length > 160) points.shift();
  savePoints(points);
  const up = points[points.length-1] >= points[points.length-2];
  chart.data.datasets[0].data = points;
  chart.data.datasets[0].borderColor = up ? '#00d27a' : '#ff4d4f';
  chart.data.datasets[0].backgroundColor = makeGradient(up);
  chart.update('active');
  priceValue.innerText = '$' + (+next).toFixed(3);
  priceArrow.innerText = up ? '▲' : '▼';
}

/* ---------------------
  Socket.IO realtime
  - Expects backend to emit:
    'connect' / 'disconnect'
    'price:update' -> { price: number }  (optional)
    'round:update' -> { round, phase:'bet'|'result'|'idle', timer, playersCount, totals: { up, down } }
    'deposit:status' -> { id, wallet, txn, status }
    'bet:placed' -> { who, side, amount } (optional)
  - Client can emit:
    'bet' -> { side:'up'|'down', amount }
    'join' -> { wallet? }
--------------------- */
const socket = io(API_BASE || '/', { path: SOCKET_PATH });

socket.on('connect', ()=> {
  console.log('socket connected', socket.id);
  // optionally identify user (wallet or uid)
  socket.emit('join', { wallet: walletEl.innerText });
});
socket.on('disconnect', ()=> console.log('socket disconnected'));

/* Price feed from server (preferred) */
socket.on('price:update', data => {
  if(!data || typeof data.price !== 'number') return;
  updateChartWithPrice(data.price);
});

/* Round updates */
socket.on('round:update', data => {
  // data: { round, phase, timer, playersCount, totals: { up, down } }
  if(!data) return;
  roundNumEl.innerText = data.round ?? roundNumEl.innerText;
  phaseEl.innerText = (data.phase || '—').toUpperCase();
  timerEl.innerText = (data.timer != null) ? data.timer + 's' : '—';
  playersCountEl.innerText = data.playersCount ?? playersCountEl.innerText;
  upTotalEl.innerText = (data.totals && data.totals.up != null) ? (+data.totals.up).toFixed(2) : upTotalEl.innerText;
  downTotalEl.innerText = (data.totals && data.totals.down != null) ? (+data.totals.down).toFixed(2) : downTotalEl.innerText;

  // server may also provide final price on result event
  if(data.phase === 'result' && data.resultPrice != null){
    updateChartWithPrice(data.resultPrice);
  }
});

/* deposit status update */
socket.on('deposit:status', d => {
  if(d && d.wallet === walletEl.innerText){
    depositStatus.innerText = d.status;
  }
});

/* bet placed update (shows in recent) */
socket.on('bet:placed', d => {
  if(!d) return;
  const node = document.createElement('div');
  node.innerHTML = `<small>${d.who} bet ${d.amount} on ${d.side.toUpperCase()}</small>`;
  recentEl.prepend(node);
  setTimeout(()=> node.remove(), 8000);
});

/* server may emit 'round:result' with winners etc */
socket.on('round:result', data => {
  if(!data) return;
  const node = document.createElement('div');
  node.innerHTML = `<strong>Round ${data.round} — ${data.result.toUpperCase()}</strong> • Winners: ${data.winners || 0}`;
  recentEl.prepend(node);
  setTimeout(()=> node.remove(), 10000);
});

/* ---------------------
  Betting actions (emit to server)
--------------------- */
function placeBetClient(side){
  const amt = parseFloat(betAmountInput.value);
  if(!amt || amt <= 0) return alert('Enter bet amount');
  // local optimistic UI (server authoritative)
  socket.emit('bet', { side, amount: amt }, (ack) => {
    // ack from server: { ok:true, balance, msg }
    if(ack && ack.ok){
      balanceEl.innerText = (+ack.balance).toFixed(2);
      const n = document.createElement('div'); n.innerHTML = `<small>You bet ${amt} on ${side.toUpperCase()}</small>`;
      recentEl.prepend(n); setTimeout(()=> n.remove(),7000);
    } else {
      alert(ack && ack.msg ? ack.msg : 'Bet failed');
    }
  });
}
betUpBtn.addEventListener('click', ()=> placeBetClient('up'));
betDownBtn.addEventListener('click', ()=> placeBetClient('down'));

/* ---------------------
  Fallback: if server doesn't push price updates,
  maintain a gentle client-side generator to keep chart moving.
--------------------- */
let clientTickerStarted = false;
function startClientTicker(){
  if(clientTickerStarted) return;
  clientTickerStarted = true;
  setInterval(()=>{
    // small movement only if no price update from server recently
    const last = points[points.length-1];
    const next = Math.max(0.01, +(last + (Math.random()-0.5)*0.2).toFixed(3));
    updateChartWithPrice(next);
  }, 1500);
}
// try to start fallback after a short timeout in case server not sending price updates
setTimeout(()=> startClientTicker(), 2500);

/* ---------------------
  Initial UI
--------------------- */
balanceEl.innerText = Number(localStorage.getItem(BAL_KEY) || 1000).toFixed(2);
</script>
</body>
</html>
